}
if((mean_start_point <- gregexpr(pattern="mean in PPP", dist_txt)[[1]][1])==-1){
mean_start_point <- gregexpr(pattern="Mean:", dist_txt)[[1]][1]+6
mean_end_point <- gregexpr(pattern=" overall sum", dist_txt)[[1]][1]-5
}else{
mean_start_point <- gregexpr(pattern="mean in PPP", dist_txt)[[1]][1]+14
mean_end_point <- gregexpr(pattern="Poverty line in", dist_txt)[[1]][1]-11
}
if(mean_start_point<mean_end_point){
mean <- substr(dist_txt,mean_start_point,mean_end_point)
}else{
mean <- NULL
}
dist <- list()
dist <- df
return(dist)
}
#Solve distributions for headcounts
GQsolve <- function(a,b,c,PL,mu){
e <- -(a+b+c+1)
m <- b^2-4*a
n <- 2*b*e-4*c
z <- PL/mu+b/2
y <- 16*z^2*m-4*m^2
x <- 16*z^2*n-4*n*m
w <- 16*z^2*e^2-n^2
p1 <- (-x-(sqrt(x^2-4*y*w)))/(2*y)
p2 <- (-x+(sqrt(x^2-4*y*w)))/(2*y)
if(p1>1 | p1<0){
p1 <- NaN
}
if(p2>1 | p2<0){
p2 <- NaN
}
return(data.table(P1=p1,P2=p2))
}
Betasolve <- function(a,b,c,PL,mu,init){
p0 <- init
N <- 10000
tol <- 1E-15
i <- 1
p1 <- p0
s <- numeric(N)
while (i<=N) {
f <- a*(p0^b)*((1-p0)^c)*((b/p0)-c/(1-p0))-(1-PL/mu)
df.dx <- a*(p0^(b-2))*((1-p0)^(c-2))*((b^2)*((p0-1)^2)+b*(p0-1)*((2*c-1)*p0+1)+(c-1)*c*(p0^2))
p1 <- (p0 - 0.01*(f/df.dx))
s[i] <- p1
i <- i + 1
if (abs(p1-p0) < tol) {break}
p0 <- p1
}
return(s[i-1])
}
###ANALYSIS
#Parameterise Povcal dists
if(!("all_dist.csv" %in% list.files("project_data") & "all_parameters.csv" %in% list.files("project_data"))){
ext <- povcal_svy()
fwrite(ext, "project_data/povcalout.csv")
ext$svy_code <- remap_cov(ext$CoverageType)
ext <- subset(ext,!is.na(svy_code))
ext$C0 <- paste(ext$CountryCode,ext$svy_code,sep="_")
data.list <- list()
data.index <- 1
errs <- c()
pb <- txtProgressBar(min=1, max=nrow(ext), style=3)
for(i in 1:nrow(ext)){
svy <- as.character(ext[i,"C0"])
year <- as.numeric(ext[i,"DataYear"])
PPP <- as.numeric(ext[i,"PPP"])
mean <- as.numeric(ext[i,"Mean"])
msg_lbl <- paste(svy,year)
setTxtProgressBar(pb, i, label=msg_lbl)
dist.tmp <- tryCatch({povcal_dist(svy, year)},error=function(e){return(NULL)})
if(!is.null(dist.tmp)){
dist.tmp$svy <- svy
dist.tmp$year <- year
dist.tmp$ppp <- PPP
dist.tmp$mean <- mean
data.list[[i]] <- dist.tmp
}
}
all_dist <- rbindlist(data.list)
fwrite(all_dist, "project_data/all_dist.csv")
parameters.list <- list()
for (i in 1:length(data.list)){
data.list[[i]]$`L(1-L)` <- data.list[[i]]$L*(1-data.list[[i]]$L)
data.list[[i]]$`(P^2-L)` <- (data.list[[i]]$P^2-data.list[[i]]$L)
data.list[[i]]$`L(P-1)` <- data.list[[i]]$L*(data.list[[i]]$P-1)
data.list[[i]]$`(P-L)` <- (data.list[[i]]$P-data.list[[i]]$L)
data.list[[i]]$`ln(P-L)` <- log(data.list[[i]]$P-data.list[[i]]$L)
data.list[[i]]$`ln(P)` <- log(data.list[[i]]$P)
data.list[[i]]$`ln(1-P)` <- log(1-data.list[[i]]$P)
data.list[[i]]$`ln(P-L)`[is.infinite(data.list[[i]]$`ln(P-L)`)] <- NA
data.list[[i]]$`ln(P)`[is.infinite(data.list[[i]]$`ln(P)`)] <- NA
data.list[[i]]$`ln(1-P)`[is.infinite(data.list[[i]]$`ln(1-P)`)] <- NA
GQ <- lm(`L(1-L)`~ 0 + `(P^2-L)` + `L(P-1)` + `(P-L)`,data.list[[i]],na.action=na.omit)$coefficients
Beta <- lm(`ln(P-L)`~ `ln(P)` + `ln(1-P)`,data.list[[i]],na.action=na.omit)$coefficients
Beta[1] <- exp(Beta[1])
parameters.temp <- as.data.frame(rbind(GQ,Beta))
parameters.temp$svy <- head(data.list[[i]]$svy,2)
parameters.temp$year <- head(data.list[[i]]$year,2)
parameters.temp$mean <- head(data.list[[i]]$mean,2)
parameters.temp$PPP <- head(data.list[[i]]$ppp,2)
parameters.temp$type <- c("GQ","Beta")
colnames(parameters.temp) <- c("A","B","C","svy","year","mean","ppp","type")
parameters.list[[i]] <- parameters.temp
}
all_parameters <- rbindlist(parameters.list)
fwrite(all_parameters, "project_data/all_parameters.csv")
} else {
all_dist <- fread("project_data/all_dist.csv")
all_parameters <- fread("project_data/all_parameters.csv")
ext <- fread("project_data/povcalout.csv")
}
#Manual addition of Afghanistan and Somalia
afg.som.lby.param <- data.table(A=c(0.935463769,0.5760727,0.88737242,0.666110634,1.002559972,0.613658334)
,B=c(-1.476794803,0.856948964,-1.254176897,0.95205282,-1.341360921,0.934277217)
,C=c(0.083512829,0.49178234,0.196100839,0.562072863,0.241518659,0.607012527)
,svy=c("AFG_3","AFG_3","SOM_3","SOM_3","LBY_3","LBY_3"),
year=c(2016.5,2016.5,2017,2017,2008,2008),
mean=c(2.788346962/12*365.2424,2.788346962/12*365.2424,1.69211737786/12*365.2424,1.69211737786/12*365.2424,4.9507954/12*365.2424,4.9507954/12*365.2424),
ppp=c(22.8388105,22.8388105,0.674879848994,0.674879848994,0.6577641,0.6577641),
type=rep(c("GQ","Beta"),3)
)
all_parameters <- rbind(all_parameters, afg.som.lby.param)
all_parameters <- merge(all_parameters, unique(ext[,c(4,34)]), by.x="svy", by.y="C0",all.x=T)
all_parameters[which(svy=="AFG_3")]$CountryName <- "Afghanistan"
all_parameters[which(svy=="SOM_3")]$CountryName <- "Somalia"
all_parameters[which(svy=="LBY_3")]$CountryName <- "Libya"
#Only most recent surveys
recent_years <- all_parameters[all_parameters[, .I[which.max(year)], by=svy]$V1][,c(1,5,9)]
recent_years$year <- round(recent_years$year,0)
#Split GQ and Beta
parameters_GQ <- all_parameters[all_parameters[, .I[which.max(year)], by=svy]$V1]
parameters_Beta <- all_parameters[all_parameters[, .I[which.max(year)], by=svy]$V1+1]
View(all_parameters)
seq(0,1,0.2)
afg2016 <- data.table(P=c(seq(0,1,0.2))
,threshold=c(331,1228,1606,2078,2900,34103))
View(afg2016)
afg2011 <- data.table(P=c(seq(0,1,0.2))
,threshold=c(330,1394,1866,2425,3379,50164))
afg2007 <- data.table(P=c(seq(0,1,0.2))
,threshold=c(269,1531,1992,2549,3486,49362))
gnq2006 <- data.table(P=c(seq(0,1,0.2))
,mean=c(0,93.52,287.4,529.7,885.98,2349.15))
View(afg2011)
afg2016 <- data.table(P=c(seq(0,1,0.2))
,value=c(331,1228,1606,2078,2900,34103)
,type="Threshold"
,country="AFG"
,year=2016)
afg2011 <- data.table(P=c(seq(0,1,0.2))
,value=c(330,1394,1866,2425,3379,50164)
,type="Threshold"
,country="AFG"
,year=2011)
afg2007 <- data.table(P=c(seq(0,1,0.2))
,value=c(269,1531,1992,2549,3486,49362)
,type="Threshold"
,country="AFG"
,year=2007)
gnq2006 <- data.table(P=c(seq(0,1,0.2))
,value=c(0,93.51677,287.39767,529.70021,885.98494,2349.15264)
,type="Mean"
,country="GNQ"
,year=2006)
gnq2011 <- data.table(P=c(seq(0,1,0.2))
,value=c(-1.895400406,-1.341110511,-0.968441459,-0.786572304,-0.491766455,0.229385605,3.723731054)
,type="Wealth"
,country="GNQ"
,year=2011)
eri2002 <- data.table(P=c(seq(0,1,0.2))
,value=c(-1.09631,-0.7318489,-0.5292656,-0.4052234,-0.1354753,1.0472504,4.40195)
,type="Wealth"
,country="ERI"
,year=2002)
lby2008 <- data.table(P=c(seq(0,1,0.2))
,value=c(0,2.0833333,3.3333333,4.4103774,5.9949622,10)
,type="Mean"
,country="LBY"
,year=2008)
som2017 <- data.table(P=c(seq(0,1,0.01))
,value=c(0.232
,0.278
,0.294
,0.335
,0.349
,0.369
,0.413
,0.439
,0.46
,0.487
,0.51
,0.522
,0.539
,0.552
,0.568
,0.583
,0.599
,0.611
,0.627
,0.638
,0.644
,0.652
,0.663
,0.68
,0.693
,0.706
,0.723
,0.735
,0.744
,0.759
,0.776
,0.786
,0.8
,0.811
,0.821
,0.832
,0.842
,0.851
,0.862
,0.873
,0.887
,0.901
,0.914
,0.93
,0.948
,0.965
,0.976
,0.988
,0.997
,1.013
,1.029
,1.043
,1.055
,1.072
,1.089
,1.108
,1.125
,1.139
,1.151
,1.171
,1.194
,1.208
,1.222
,1.244
,1.258
,1.279
,1.303
,1.323
,1.348
,1.367
,1.389
,1.411
,1.44
,1.464
,1.483
,1.525
,1.543
,1.56
,1.591
,1.631
,1.67
,1.712
,1.79
,1.84
,1.9
,1.972
,,2.039
,2.112
,2.182
,2.262
,2.35
,2.475
,2.58
,2.671
,2.833
,3.045
,3.344
,3.74
,4.338
,6.857)
,type="Mean"
,country="SOM"
,year=2017)
a
gnq2011 <- data.table(P=c(seq(0,0.2,0.4,0.5,0.6,0.8,1))
,value=c(-1.895400406,-1.341110511,-0.968441459,-0.786572304,-0.491766455,0.229385605,3.723731054)
,type="Wealth"
,country="GNQ"
,year=2011)
gnq2011 <- data.table(P=c(0,0.2,0.4,0.5,0.6,0.8,1)
,value=c(-1.895400406,-1.341110511,-0.968441459,-0.786572304,-0.491766455,0.229385605,3.723731054)
,type="Wealth"
,country="GNQ"
,year=2011)
eri2002 <- data.table(P=c(0,0.2,0.4,0.5,0.6,0.8,1)
,value=c(-1.09631,-0.7318489,-0.5292656,-0.4052234,-0.1354753,1.0472504,4.40195)
,type="Wealth"
,country="ERI"
,year=2002)
som2017 <- data.table(P=c(seq(0,1,0.01))
,value=c(0.232
,0.278
,0.294
,0.335
,0.349
,0.369
,0.413
,0.439
,0.46
,0.487
,0.51
,0.522
,0.539
,0.552
,0.568
,0.583
,0.599
,0.611
,0.627
,0.638
,0.644
,0.652
,0.663
,0.68
,0.693
,0.706
,0.723
,0.735
,0.744
,0.759
,0.776
,0.786
,0.8
,0.811
,0.821
,0.832
,0.842
,0.851
,0.862
,0.873
,0.887
,0.901
,0.914
,0.93
,0.948
,0.965
,0.976
,0.988
,0.997
,1.013
,1.029
,1.043
,1.055
,1.072
,1.089
,1.108
,1.125
,1.139
,1.151
,1.171
,1.194
,1.208
,1.222
,1.244
,1.258
,1.279
,1.303
,1.323
,1.348
,1.367
,1.389
,1.411
,1.44
,1.464
,1.483
,1.525
,1.543
,1.56
,1.591
,1.631
,1.67
,1.712
,1.79
,1.84
,1.9
,1.972
,2.039
,2.112
,2.182
,2.262
,2.35
,2.475
,2.58
,2.671
,2.833
,3.045
,3.344
,3.74
,4.338
,6.857)
,type="Mean"
,country="SOM"
,year=2017)
som2017 <- data.table(P=c(seq(0,1,0.01))
,value=c(0
,0.232
,0.278
,0.294
,0.335
,0.349
,0.369
,0.413
,0.439
,0.46
,0.487
,0.51
,0.522
,0.539
,0.552
,0.568
,0.583
,0.599
,0.611
,0.627
,0.638
,0.644
,0.652
,0.663
,0.68
,0.693
,0.706
,0.723
,0.735
,0.744
,0.759
,0.776
,0.786
,0.8
,0.811
,0.821
,0.832
,0.842
,0.851
,0.862
,0.873
,0.887
,0.901
,0.914
,0.93
,0.948
,0.965
,0.976
,0.988
,0.997
,1.013
,1.029
,1.043
,1.055
,1.072
,1.089
,1.108
,1.125
,1.139
,1.151
,1.171
,1.194
,1.208
,1.222
,1.244
,1.258
,1.279
,1.303
,1.323
,1.348
,1.367
,1.389
,1.411
,1.44
,1.464
,1.483
,1.525
,1.543
,1.56
,1.591
,1.631
,1.67
,1.712
,1.79
,1.84
,1.9
,1.972
,2.039
,2.112
,2.182
,2.262
,2.35
,2.475
,2.58
,2.671
,2.833
,3.045
,3.344
,3.74
,4.338
,6.857)
,type="Mean"
,country="SOM"
,year=2017)
